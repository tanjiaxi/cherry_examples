version: '3.8'

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: cherry-etcd
    hostname: dev.com
    ports:
      - "2379:2379"  # 客户端通信端口
      - "2380:2380"  # 服务器间通信端口
    environment:
      # 节点名称
      - ETCD_NAME=cherry-etcd-node
      
      # 数据目录
      - ETCD_DATA_DIR=/etcd-data
      
      # 监听地址
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      
      # 广告地址（其他节点访问地址）
      - ETCD_ADVERTISE_CLIENT_URLS=http://dev.com:2379
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://dev.com:2380
      
      # 集群配置（单节点）
      - ETCD_INITIAL_CLUSTER=cherry-etcd-node=http://dev.com:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=cherry-etcd-cluster
      
      # 安全配置
      - ETCD_AUTO_COMPACTION_RETENTION=1
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      
      # 日志配置
      - ETCD_LOG_LEVEL=info
      - ETCD_LOGGER=zap
      - ETCD_LOG_OUTPUTS=stderr
    volumes:
      - etcd_data:/etcd-data
      - ./logs:/var/log/etcd
    networks:
      - cherry-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # etcd Web UI (可选)
  etcd-manager:
    image: evildecay/etcdkeeper:latest
    container_name: cherry-etcd-manager
    ports:
      - "8080:8080"
    environment:
      - ETCD_HOST=etcd
      - ETCD_PORT=2379
    depends_on:
      - etcd
    networks:
      - cherry-network
    restart: unless-stopped

volumes:
  etcd_data:
    driver: local

networks:
  cherry-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16