# Cherryæ¡†æ¶ etcd Dockerç¯å¢ƒ Makefile

.PHONY: help build up down logs test backup clean status

# é»˜è®¤ç›®æ ‡
help:
	@echo "Cherryæ¡†æ¶ etcd Dockerç¯å¢ƒ"
	@echo "=========================="
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make up      - å¯åŠ¨etcdæœåŠ¡"
	@echo "  make down    - åœæ­¢etcdæœåŠ¡"
	@echo "  make logs    - æŸ¥çœ‹etcdæ—¥å¿—"
	@echo "  make test    - æµ‹è¯•etcdåŠŸèƒ½"
	@echo "  make backup  - å¤‡ä»½etcdæ•°æ®"
	@echo "  make status  - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make clean   - æ¸…ç†æ‰€æœ‰æ•°æ®"
	@echo "  make build   - æ„å»ºè‡ªå®šä¹‰é•œåƒ"

# å¯åŠ¨æœåŠ¡
up:
	@echo "ğŸš€ å¯åŠ¨Cherry etcdæœåŠ¡..."
	@echo "127.0.0.1 dev.com" | sudo tee -a /etc/hosts || true
	docker-compose up -d
	@echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"
	@echo "ğŸ“¡ etcdç«¯ç‚¹: http://dev.com:2379"
	@echo "ğŸŒ Webç®¡ç†ç•Œé¢: http://localhost:8080"

# åœæ­¢æœåŠ¡
down:
	@echo "ğŸ›‘ åœæ­¢Cherry etcdæœåŠ¡..."
	docker-compose down
	@echo "âœ… æœåŠ¡å·²åœæ­¢"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹etcdæ—¥å¿—..."
	docker-compose logs -f etcd

# æµ‹è¯•etcdåŠŸèƒ½
test:
	@echo "ğŸ§ª æµ‹è¯•etcdåŠŸèƒ½..."
	@./scripts/test-etcd.sh

# å¤‡ä»½æ•°æ®
backup:
	@echo "ğŸ’¾ å¤‡ä»½etcdæ•°æ®..."
	@./scripts/backup-etcd.sh

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
	@docker-compose ps
	@echo ""
	@echo "ğŸ¥ å¥åº·æ£€æŸ¥:"
	@docker exec cherry-etcd etcdctl endpoint health 2>/dev/null || echo "âŒ etcdæœåŠ¡æœªè¿è¡Œ"

# æ¸…ç†æ‰€æœ‰æ•°æ®
clean:
	@echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰æ•°æ®..."
	@read -p "ç¡®å®šè¦åˆ é™¤æ‰€æœ‰etcdæ•°æ®å—ï¼Ÿ(y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	docker-compose down -v
	docker volume rm etcd_etcd_data 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ„å»ºè‡ªå®šä¹‰é•œåƒ
build:
	@echo "ğŸ”¨ æ„å»ºCherry etcdé•œåƒ..."
	docker build -t cherry-etcd:latest .
	@echo "âœ… é•œåƒæ„å»ºå®Œæˆ"

# é‡å¯æœåŠ¡
restart: down up

# è¿›å…¥etcdå®¹å™¨
shell:
	@echo "ğŸš è¿›å…¥etcdå®¹å™¨..."
	docker exec -it cherry-etcd sh

# æŸ¥çœ‹etcdç‰ˆæœ¬
version:
	@echo "ğŸ“‹ etcdç‰ˆæœ¬ä¿¡æ¯:"
	@docker exec cherry-etcd etcd --version 2>/dev/null || echo "âŒ etcdæœåŠ¡æœªè¿è¡Œ"

# ç›‘æ§etcdæ€§èƒ½
monitor:
	@echo "ğŸ“ˆ etcdæ€§èƒ½ç›‘æ§..."
	@docker exec cherry-etcd etcdctl endpoint status --write-out=table 2>/dev/null || echo "âŒ etcdæœåŠ¡æœªè¿è¡Œ"

# å¿«é€Ÿå¯åŠ¨ï¼ˆåŒ…å«hostsé…ç½®ï¼‰
quick-start: up test
	@echo "ğŸ‰ Cherry etcdç¯å¢ƒå·²å°±ç»ªï¼"